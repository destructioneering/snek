<!DOCTYPE html>
<html>
  <head><meta charset="utf-8">
    <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython.min.js">
    </script>
    <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython_stdlib.js">
    </script>
    <script src="/static/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/mode-python.js" type="text/javascript" charset="utf-8"></script>
    <script src="/static/theme-solarized_light.js" type="text/javascript" charset="utf-8"></script>
    <script src="//code.jquery.com/jquery-3.6.0.js"></script>
    <script src="//code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fenix&family=Inder&family=Montserrat&family=Roboto&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
  </head>
  <body onload="brython()">
    <div class="container">
      <div class="title">
        <div>Snek demo</div>
        <a href="https://gitlab.eecs.wsu.edu/twest/snek">
          <img width="20px" src="{{ url_for('routes.static', path='gitlab-icon-rgb.svg') }}" />
        </a>
      </div>
      <div class="content-container">
        <div class="left-container">
          <div class="run-button">
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            </div>
          </div>
          <div id="editor" class="editor">{% include "demo.snek" %}</div>
        </div>
        <div class="right-container">
          <div class="tab-container">
            <div class="tab console-button button-pressed">Console output</div>
            <div class="tab gc-button">GC events</div>
            <div class="tab help-button">Help</div>
          </div>
          <div class="tab-content-container">
            <div class="console-output-tab" style="display: block" ></div>
            <div class="gc-events-tab">bar</div>
            <div class="help-tab">baz</div>
          </div>
        </div>
      </div>
    </div>

    <script type="text/python">
      from browser import document, window, html
      from io import StringIO
      import sys

      from Lexer import Lexer
      from Parser import Parser
      from Evaluator import Evaluator

      def handleCode(text):
          lexer = Lexer(text)
          lexer.tokenize()

          parser = Parser(lexer.tokens)
          parser.parse()

          old_stdout = sys.stdout
          sys.stdout = mystdout = StringIO()

          evaluator = Evaluator()
          for statement in parser.statements:
              evaluator.eval(statement)

          sys.stdout = old_stdout
          output = mystdout.getvalue()
          outputElement = document.select('.console-output-tab')[0]

          outputElement.clear()

          for i, line in enumerate(output.splitlines()):
              container = html.DIV('', Class="output-line-container")
              outputElement <= container
              container <= html.DIV(html.DIV(i), Class="line-number")
              container <= html.DIV(line, Class="output-line")

      window.handleCode = handleCode
    </script>
    <script>
      $(document).ready(function() {
          // Set up the editor.
          var editor = ace.edit("editor", {
              wrap: true,
          });
          var PythonMode = ace.require("ace/mode/python").Mode;
          editor.session.setMode(new PythonMode());
          editor.setTheme("ace/theme/solarized_light");

          $('.run-button').click(function() {
              window.handleCode(editor.getValue());
          });

          // Set up the tabs.
          $('.console-button').click(function() {
              $('.gc-events-tab').hide()
              $('.help-tab').hide()
              $('.console-output-tab').show()

              $('.tab').removeClass('button-pressed');
              $(this).addClass('button-pressed');
              $('.run-button').show()
          });

          $('.gc-button').click(function() {
              $('.console-output-tab').hide()
              $('.help-tab').hide()
              $('.gc-events-tab').show()

              $('.tab').removeClass('button-pressed');
              $(this).addClass('button-pressed');
              $('.run-button').hide()
          });

          $('.help-button').click(function() {
              $('.gc-events-tab').hide()
              $('.console-output-tab').hide()
              $('.help-tab').show()

              $('.tab').removeClass('button-pressed');
              $(this).addClass('button-pressed');
              $('.run-button').hide()
          });
      });
    </script>
  </body>
</html>
